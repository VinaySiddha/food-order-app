<html>
  <head>
    <title>Chef View</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body class="bg-[#fcf8f8]" style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>
    <div class="max-w-4xl mx-auto mt-10 bg-white rounded-xl shadow p-6">
      <h1 class="text-2xl font-bold mb-6 text-[#1b0e0e]">Chef Orders Dashboard</h1>
      <table class="w-full border">
        <thead>
          <tr class="bg-[#f3e7e8]">
            <th class="px-4 py-2 text-left">Order ID</th>
            <th class="px-4 py-2 text-left">Items</th>
            <th class="px-4 py-2 text-left">Total</th>
            <th class="px-4 py-2 text-left">Status</th>
            <th class="px-4 py-2 text-left">Time</th>
            <th class="px-4 py-2 text-left">Action</th>
          </tr>
        </thead>
        <tbody id="chef-orders-tbody"></tbody>
      </table>
    </div>
    <div class="fixed top-6 right-10 z-50">
      <button id="bell-btn" class="relative">
        <svg id="bell-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-700">
          <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a2.25 2.25 0 01-4.714 0M21 19.5a1.5 1.5 0 01-1.5-1.5V11a7.5 7.5 0 10-15 0v7a1.5 1.5 0 01-1.5 1.5h18z" />
        </svg>
        <span id="bell-dot" class="absolute top-0 right-0 block h-3 w-3 rounded-full bg-red-500 border-2 border-white hidden"></span>
      </button>
    </div>
    <!-- Popup Modal -->
    <div id="order-popup" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
      <div class="bg-white p-6 rounded shadow-xl max-w-md w-full">
        <h2 class="text-xl font-bold mb-4">New Order Received!</h2>
        <div id="popup-order-details" class="mb-4"></div>
        <button id="close-popup" class="bg-blue-500 text-white px-4 py-2 rounded">Close</button>
      </div>
    </div>
    <script>
      async function renderChefOrders() {
        const tbody = document.getElementById('chef-orders-tbody');
        tbody.innerHTML = '';
        try {
          const response = await fetch('http://localhost:8000/admin/orders');
          const orders = await response.json();
          orders.forEach((order, idx) => {
            const tr = document.createElement('tr');
            tr.className = "border-t";
            tr.innerHTML = `
              <td class="px-4 py-2">${order.order_id}</td>
              <td class="px-4 py-2">${order.items.map(i => `${i.name} x${i.quantity}`).join('<br>')}</td>
              <td class="px-4 py-2">$${order.total_amount.toFixed(2)}</td>
              <td class="px-4 py-2">${order.status}</td>
              <td class="px-4 py-2">${order.timestamp}</td>
              <td class="px-4 py-2">
                <select onchange="updateOrderStatus(${order.order_id}, this.value)" class="border rounded px-2 py-1">
                  <option value="Placed" ${order.status === 'Placed' ? 'selected' : ''}>Placed</option>
                  <option value="Preparing" ${order.status === 'Preparing' ? 'selected' : ''}>Preparing</option>
                  <option value="Ready" ${order.status === 'Ready' ? 'selected' : ''}>Ready</option>
                  <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
                </select>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          console.error('Error fetching orders:', error);
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Failed to load orders.</td></tr>';
        }
      }

      window.updateOrderStatus = async function(orderId, newStatus) {
        try {
          await fetch(`/admin/order/${orderId}/done`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
          });
          renderChefOrders(); // Refresh orders after update
        } catch (error) {
          console.error('Error updating order status:', error);
          alert('Failed to update order status.');
        }
      };

      // WebSocket for real-time order notifications
      let ws;
      function connectWebSocket() {
        ws = new WebSocket('ws://localhost:8000/ws/orders');
        ws.onmessage = function(event) {
          const order = JSON.parse(event.data);
          showBellNotification(order);
        };
        ws.onclose = function() {
          setTimeout(connectWebSocket, 2000); // Reconnect on disconnect
        };
      }
      connectWebSocket();

      function showBellNotification(order) {
        document.getElementById('bell-dot').classList.remove('hidden');
        // Show popup with order details
        const details = `
          <p><b>Order ID:</b> ${order.order_id}</p>
          <p><b>Items:</b><br>${order.items.map(i => `${i.name} x${i.quantity}`).join('<br>')}</p>
          <p><b>Total:</b> $${order.total_amount.toFixed(2)}</p>
          <p><b>Status:</b> ${order.status}</p>
          <p><b>Time:</b> ${order.timestamp}</p>
        `;
        document.getElementById('popup-order-details').innerHTML = details;
        document.getElementById('order-popup').classList.remove('hidden');
        renderChefOrders(); // Refresh orders after notification
      }

      document.getElementById('close-popup').onclick = function() {
        document.getElementById('order-popup').classList.add('hidden');
        document.getElementById('bell-dot').classList.add('hidden');
      };
      document.getElementById('bell-btn').onclick = function() {
        document.getElementById('order-popup').classList.toggle('hidden');
        document.getElementById('bell-dot').classList.add('hidden');
      };

      renderChefOrders();
    </script>
  </body>
</html>
